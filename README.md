# User Registration API

Simple user registration and activation API built with **FastAPI** and **PostgreSQL**.

The API allows a client to:

- Create a user with **email + password**
- Generate and send a **4-digit activation code** via a third-party HTTP email service (mocked)
- Activate the account using:
  - **BASIC AUTH** (email + password)
  - The **4-digit code** received
- Enforce that the activation code is valid for **only 1 minute**

Everything runs in containers using **Docker** or **Podman**.

---

## Tech Stack

- **Backend:** FastAPI (Python 3.11)
- **Database:** PostgreSQL 14
- **Email service:** HTTP mock service (simple Python `http.server`)
- **Auth:** Basic Auth for activation
- **Tests:** pytest + FastAPI TestClient

---

## Project Structure

```text
.
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py               # FastAPI app factory & router wiring
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ users.py      # /users and /users/activate endpoints
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ schemas.py        # Pydantic models (UserCreate, ActivationRequest)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_service.py   # create_user / activate_user logic
â”‚   â”‚   â””â”€â”€ email_service.py  # send_activation_email via HTTP third party
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ connection.py     # PostgreSQL connection + optional pool
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ logging.py        # registration logger + redact_email()
â”‚
â”œâ”€â”€ db-init/
â”‚   â””â”€â”€ 01_schema.sql         # CREATE TABLE users + activation_codes
â”‚
â”œâ”€â”€ email-mock/
â”‚   â””â”€â”€ server.py             # HTTP mock: POST /send, prints activation code
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_registration.py  # tests for /users
â”‚   â””â”€â”€ test_activation.py    # tests for /users/activate
â”‚
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

---
## ğŸš€ How to Run the API

You can run the entire stack (API, PostgreSQL, email-mock service) using **Docker** or **Podman**.

### 1ï¸âƒ£ Start the application

**With Docker:**
```bash
docker compose up --build
```
**With podman:**
```bash
podman compose --file docker-compose.yml up --detach
```

This launches:

- FastAPI backend â†’ http://localhost:8000

- PostgreSQL database

- Email mock server â†’ http://localhost:3001/send

---

### 2ï¸âƒ£ Check that the API is running
```bash
curl http://localhost:8000/health
```
Expected:
```json
{"status": "ok"}
```

---
## ğŸ§ª Running the Tests
You can execute the automated tests with pytest from inside the container.
```bash
podman exec -it user-registration-api-app-1 sh -c "cd /app && PYTHONPATH=/app pytest -q"
```

## ğŸ“¦ Requirements

To run the API using containers, you need:

- Docker Engine + Docker Compose
- or
- Podman + podman-compose (or Podman v4+ with built-in compose)

No local Python installation is required â€” everything runs inside containers.

---
## ğŸ§ª How to Test the Endpoints

Below are simple `curl` commands to test both the **registration** and **activation** flows.

---

### 1ï¸âƒ£ Test User Registration (`POST /users`)

```bash
curl -X POST http://localhost:8000/users \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"StrongPass123"}'
```
Expected response:
```json
{"message": "User created. Check your email for activation code."}
```
Check the logs to see the activation code generated by the mock email service:
```scss
[MOCK EMAIL] Activation code for u***********r@example.com: 6270
```
Save the 4-digit code printed in the logs (e.g., 6270).

### 2ï¸âƒ£ Test User Activation (POST /users/activate)
Replace the code below with the one printed in your logs.
```bash
curl -X POST http://localhost:8000/users/activate \
  -u "user@example.com:StrongPass123" \
  -H "Content-Type: application/json" \
  -d '{"code": "6270"}'
```
Expected successful activation response:
```json
{"message": "Account activated"}
```
ğŸ›‘ Invalid or expired code

If the code is wrong or older than 1 minute, you will get:
```json
{"detail": "Invalid or expired code"}
```
